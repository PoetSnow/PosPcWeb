@using Gemstar.BSPMS.Hotel.Services.EnumsPos;
@using Gemstar.BSPMS.Hotel.Web.Areas.PosManage.Models.PosTabStatus;
@model TabStatusViewModel
@{
    ViewBag.Title = "Pos楼面";
}

<link href="~/Content/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" />
<link href="~/Scripts/layer-v3.1.1/theme/default/layer.css" rel="stylesheet" />
<link href="~/Content/Pos/posTabStatus.css?version=@ViewBag.Version" rel="stylesheet" />
<link href="~/Content/Pos/posPublic.css?version=@ViewBag.Version" rel="stylesheet" />
<link href="~/Content/liMarquee.css" rel="stylesheet" />

@using (Html.BeginForm())
{
    <input id="billid" type="hidden" value="" />
    <input id="tabid" type="hidden" value="@Model.Tabid" />
    <input id="refeid" type="hidden" value="@Model.Refeid" />
    <input id="tabtype" type="hidden" value="@(Model.Tabtype)" />
    <input id="tabStatus" type="hidden" value="@(Model.TabStatus)" />
    <input id="pageIndex" type="hidden" value="@(Model.PageIndex)" />
    <input id="pageSize" type="hidden" value="@(Model.PageSize)" />
    <input id="pageTotal" type="hidden" value="@(Model.PageTotal)" />
    <input id="isOpenBrush" type="hidden" value="@(Model.IsOpenBrush == 1 ? true : false)" />
    <input id="isAutoLogin" type="hidden" value="@(ViewBag.IsAutoLogin == true ? " true":"false" )" />
    <input id="tipsTime" type="hidden" value="@(Convert.ToInt32(ViewBag.TipsTime ?? 5) * 1000)" />
    <input id="tabNo" type="hidden" value="" />
    <!--锁台记录D-->
    <input id="selIds" type="hidden" value="" />
    <div class="mainLeft" style="display:none;">
        <ul class="mainLeft-top">
            <li>
                <label id="lblData">@(string.Format("{0:yyyy-MM-dd}", Model.Business))</label>
            </li>
            <li>
                <input id="btnRefe" type="button" value="全部营业点" onclick="selectRefe()" style="color:#fff;" />
            </li>
            <li>
                <input id="btnTabtype" type="button" value="全部餐台类型" onclick="selectTabtype()" style="color:#fff;" />
            </li>
            <li>
                <input id="txtTabCode" type="text" onclick="letterInput('#txtTabCode')" placeholder="台号/台名首字母" value="@(Model.Code??" ")" />
            </li>
        </ul>
        <ul class="mainLeft-status">
            <li class="staus-all">
                <a href="javascript:void(0)" onclick="queryAll()">
                    <span id="All">0</span><br /><span>全部</span>
                </a>
            </li>
            <li class="">
                <a href="javascript:void(0)">
                    <span>&nbsp;</span><br /><span>&nbsp;</span>
                </a>
            </li>
            <li class="staus-empty">
                <a href="javascript:void(0)" onclick="tabStatusQuery(@((byte)PosTabStatusEnum.空净))">
                    <span id="Empty">0</span><br /><span>空净</span>
                </a>
            </li>
            <li class="staus-beAlone">
                <a href="javascript:void(0)" onclick="tabStatusQuery(@((byte)PosTabStatusEnum.落单后超时未有再点菜))">
                    <span id="BeAlone">0</span><br /><span>落单超时</span>
                </a>
            </li>
            <li class="staus-repair">
                <a href="javascript:void(0)" onclick="tabStatusQuery(@((byte)PosTabStatusEnum.维修))">
                    <span id="Repair">0</span><br /><span>维修</span>
                </a>
            </li>
            <li class="staus-sit">
                <a href="javascript:void(0)" onclick="tabStatusQuery(@((byte)PosTabStatusEnum.就座))">
                    <span id="Sit">0</span><br /><span>就座</span>
                </a>
            </li>
            <li class="staus-reserve">
                <a href="javascript:void(0)" onclick="tabStatusQuery(@((byte)PosTabStatusEnum.预订))">
                    <span id="Reserve">0</span><br /><span>预订</span>
                </a>
            </li>
            <li class="staus-intimidate">
                <a href="javascript:void(0)" onclick="tabStatusQuery(@((byte)PosTabStatusEnum.已打单超时未买单))">
                    <span id="Intimidate">0</span><br /><span>打单超时</span>
                </a>
            </li>
            <li class="staus-clean">
                <a href="javascript:void(0)" onclick="tabStatusQuery(@((byte)PosTabStatusEnum.已买单未离座))">
                    <span id="Clean">0</span><br /><span>清洁中</span>
                </a>
            </li>
            <li class="staus-operation">
                <a href="javascript:void(0)" onclick="tabStatusQuery('8')">
                    <span id="Operation">0</span><br /><span>正在操作</span>
                </a>
            </li>
        </ul>
        <ul class="mainLeft-total">
            <li><span>总人数：</span><span id="TotalNumber"></span></li>
            <li><span>开台数：</span><span id="OriginalNumber"></span></li>
            <li><span>已买单：</span><span id="PayBill"></span></li>
        </ul>
        <div>
            <label id="lblTime">@(string.Format("{0:HH:mm:ss}", DateTime.Now))</label>
        </div>
        <!-- 提示信息 -->
        <div class="tips" data-id="#lblData" data-position="2" data-msg="当前营业日、图例显示和统计，以及可以按营业点、餐台类型和台号查询。另外还可以统计开台数和人数的统计。" onmouseover="tipShow(this)" onmouseout="tipHide(this)" onclick="tipMsg(this)"><i class="fa fa-question-circle-o" aria-hidden="true"></i></div>
    </div>

    <div class="mainRight">
        <div class="mainRight-list">
            <ul><li></li></ul>
        </div>
        <div class="mainRight-foot">
            <ul>
                <li class="sx"><a href="javascript:void(0)" onclick="refresh()">@*<img src="~/images/posTabStatus/shuax.png" />*@刷新</a></li>
                <li class="qt"><a href="javascript:void(0)" onclick="sellOut()">沽清</a></li>
                <li class="qt"><a href="javascript:void(0)" onclick="Restoration()">复位</a></li>
                <li class="qt" style="display:none"><a href="javascript:void(0)">@*<img src="~/images/posTabStatus/bianh.png" />*@编号</a></li>
                <li class="qt" style="display:none"><a href="javascript:void(0)">@*<img src="~/images/posTabStatus/suop.png" />*@锁屏</a></li>
                <li class="qt" style="display:none"><a href="javascript:void(0)">@*<img src="~/images/posTabStatus/fuw.png" />*@服务</a></li>
                <li class="qt" style="display:none"><a href="javascript:void(0)">@*<img src="~/images/posTabStatus/xiaof.png" />*@消费</a></li>
                <li class="qt"><a id="openShrink" href="javascript:void(0)" onclick="OpenShrink(this)">展开</a></li>
                <li class="qt"><a href="javascript:void(0)" onclick="fullScreen(this)">全屏</a></li>
                <li class="sx"><a href="javascript:void(0)" onclick="exitTabStatus()">退出</a></li>
            </ul>
            <ul class="mesage str_wrap">
                <li></li>
            </ul>
            <ul>
                <li class="pageing"><a href="javascript:void(0)" style="color:#fff" onclick="pageTurning('1')">上一页</a></li>
                <li class="pageing"><a href="javascript:void(0)" style="color:#fff" onclick="pageTurning('2')">下一页</a></li>
            </ul>
        </div>
        <!-- 提示信息 -->
        <div class="tips" data-id=".mainRight .tips:last-child" data-position="3" data-msg="当前收银点对应的餐台显示，餐台状态分为：空净、维修、预订、落单超时、就座、打单超时、清洁中和正在操作。餐台显示可以按不同的分辩率显示，且各行和列的宽度都是根据屏幕的剩余宽度平均算出来的。" onmouseover="tipShow(this)" onmouseout="tipHide(this)" onclick="tipMsg(this)"><i class="fa fa-question-circle-o" aria-hidden="true"></i></div>
    </div>
}
<script src="~/Scripts/jquery.liMarquee.js"></script>
<script type="text/javascript">
    window.setInterval(function () {
        var date = new Date().FormatTime("HH:mm:ss");
        $("#lblTime").text(date);
    }, 1000);

    window.setInterval(function () {
        var model = {
            Code: $("#txtTabCode").val(),
            Refeid: $("#refeid").val(),
            Tabtype: $("#tabtype").val(),
            TabStatus: $("#tabStatus").val(),
            PageSize: $("#pageSize").val(),
            PageIndex: 1,
            Mode: localStorage.getItem("posMode")
        };
        queryTabStatus(model);
        
        refreshFaultPrinter();
    }, @(Convert.ToInt32(ViewBag.TabStatusRefreshInterval ?? 30) * 1000));

    $(window).resize(function () {          //当浏览器大小变化时
        setTimeout(function () {
            InTabStatusList();
        }, 200);
    });

    $(function () {

        if (localStorage.getItem("refename") != null) {
            $("#btnRefe").val(localStorage.getItem("refename"));
        }
        $("#refeid").val(localStorage.getItem("refeid"));//
       
        InTabStatusList();

        refreshFaultPrinter();
       
    });

    //初始化餐台列表
    function InTabStatusList() {
        splitInterval();

        var listHeight = Math.floor($(".mainRight-list ul").height());
        var listWidth = Math.floor($(".mainRight-list ul").width());
        var liHeight = $(".mainRight-list li").first().outerHeight(true);
        var liWidth = $(".mainRight-list li").first().outerWidth(true);

        var widthDecimal = parseFloat(listWidth / liWidth) - Math.floor(listWidth / liWidth);
        var heightDecimal = parseFloat(listHeight / liHeight) - Math.floor(listHeight / liHeight);

        var size = parseInt(listWidth / liWidth) * parseInt(listHeight / liHeight);

        if(widthDecimal > 0.5 && heightDecimal > 0.5)
        {
            size =  Math.ceil(listWidth / liWidth) *  Math.floor(listHeight / liHeight);
        }
        else if(widthDecimal > 0.1 && heightDecimal > 0.5)
        {
            size = Math.floor(listWidth / liWidth) * Math.floor(listHeight / liHeight);
        }
        $("#pageIndex").val(1);
        $("#pageSize").val(size);

        var model = {
            Code: $("#txtTabCode").val(),
            Refeid: $("#refeid").val(),
            Tabtype: $("#tabtype").val(),
            TabStatus: $("#tabStatus").val(),
            PageIndex: $("#pageIndex").val(),
            PageSize: $("#pageSize").val(),
            Mode: localStorage.getItem("posMode")
        };
        queryTabStatus(model);
        setTabBackClass();
    }
    //翻页
    function pageTurning(operation) {
        var index = parseInt($("#pageIndex").val());
        var total = parseInt($("#pageTotal").val());
        var size = parseInt($("#pageSize").val());
        var number = (total % size) > 0 ? parseInt(total / size) + 1 : parseInt(total / size);

        if (operation == "1") {
            index -= 1;
        }
        else {
            index += 1;
        }

        if (index < 1 || index > number) {
            return false;
        }

        var model = {
            Code: $("#txtTabCode").val(),
            Refeid: $("#refeid").val(),
            Tabtype: $("#tabtype").val(),
            TabStatus: $("#tabStatus").val(),
            PageIndex: index,
            PageSize: $("#pageSize").val(),
            Mode: localStorage.getItem("posMode"),
        };
        queryTabStatus(model);
    }

    //查询餐台
    function queryTabStatus(model) {
        $.ajax({
            url: '@Url.Action("_PosTabStatusList", "PosTabStatus")',
            type: "post",
            data: model,
            dataType: "html",
            success: function (data) {
                $("#pageIndex").val(model.PageIndex);
                $(".mainRight-list").html(data);
                splitInterval();
                setTabBackClass();
                getTotal(model);
                getStatistics(model);
                if ($("#business").val() != $("#lblData").text()) {
                    $("#lblData").text($("#business").val());
                }
                //设置正在操作餐台的样式
                $(".tabstatus li").each(function(){
                    var lockId=$(this).find("a").attr("data-locktabid");
                    if (lockId!="") {
                        $(this).attr("class", "staus-operation");
                    }
                })
            },
            error: function (data) {
                layer.alert(data.responseText, { title: "快点云Pos提示" });
            }
        });
    }

    //获取总数
    function getTotal(model) {
        $.ajax({
            url: '@Url.Action("GetTabStatusTotal", "PosTabStatus")',
            type: "post",
            data: model,
            dataType: "text",
            success: function (data) {
                $("#pageTotal").val(data);
            },
            error: function (data) {
                layer.alert(data.responseText, { title: "快点云Pos提示" });
            }
        });
    }

    //选择营业点
    function selectRefe()
    {
        $.ajax({
            url: '@Url.Action("_PosRefeList", "PosTabStatus")',
            type: "post",
            data: {},
            dataType: "html",
            success: function (data) {
                layer.open({
                    type: 1,
                    title: "选择营业点",
                    scrollbar: false,//禁止滚动条
                    skin: 'layui-layer-demo', //样式类名
                    closeBtn: 0, //不显示关闭按钮
                    shadeClose: true, //开启遮罩关闭
                    area: ['70rem', '40rem'], //宽高
                    maxWidth:"75%",
                    maxHeight:"75%",
                    content: data
                });
                $(".wrap").css({ "margin" : 0});
                $(".layui-layer-content").css({"overflow":"hidden"});
            },
            error: function (data) {
                layer.alert(data.responseText, { title: "快点云Pos提示" });
            }
        });

    }

    //选择选择餐台类型
    function selectTabtype()
    {
        var refeId=  $("#refeid").val();
        $.ajax({
            url: '@Url.Action("_PosTabTypeList", "PosTabStatus")',
            type: "post",
            data: {refeId:refeId},
            dataType: "html",
            success: function (data) {
                layer.open({
                    type: 1,
                    title: "选择餐台类型",
                    scrollbar: false,//禁止滚动条
                    closeBtn: 0, //不显示关闭按钮
                    shadeClose: true, //开启遮罩关闭
                    area: ['70rem', '40rem'], //宽高
                    maxWidth:"75%",
                    maxHeight:"75%",
                    content: data
                });
                $(".wrap").css({ "margin" : 0});
                $(".layui-layer-content").css({"overflow":"hidden"});
            },
            error: function (data) {
                layer.alert(data.responseText, { title: "快点云Pos提示" });
            }
        });

    }

    //字母键盘
    function letterInput(tag)
    {
        var model = {
            Tag: tag
            ,Display:"none;"
            ,Callback: "refresh();"
            ,InputCallback:"refresh();"
        };
        $.ajax({
            url: '@Url.Action("_LetterInput", "PosTabStatus")',
            type: "post",
            data: model,
            dataType: "html",
            success: function (data) {
                layer.open({
                    type: 4,
                    title: false,
                    closeBtn: 0,
                    scrollbar: false,
                    shadeClose: true,
                    tips: [2, '#00000000'],
                    content: [data, tag]
                });

                $(".wrap").css({ "margin" : 0});
                $(".layui-layer-tips .layui-layer-content").css({"overflow":"hidden","margin":"0","padding":"0","background":"rgba(150, 150, 150, 0.9)"});
            },
            error: function (data) {
                layer.alert(data.responseText, { title: "快点云Pos提示" });
            }
        });
    }

    //数字键盘
    function numberInput(obj,tag)
    {
        if($(obj).attr("data-keyboardShow") == 1)
        {
            var model = {
                Tag: "#" + $(tag).parents(".otbIGuest").find("input").last().attr("id")
                ,Display:"none;"
                ,Callback: "closeTips();"
                ,InputCallback:"inputIGuest();"
            };
            $.ajax({
                url: '@Url.Action("_NumberInput", "PosInSingle")',
                type: "post",
                data: model,
                dataType: "html",
                success: function (data) {
                    layer.open({
                        type: 4
                        ,title: false
                        ,closeBtn: 0
                        ,shade:false
                        ,scrollbar: false
                        ,shadeClose: true
                        ,tips: [2]
                        ,content: [data, tag]
                    });

                    $(".wrap").css({ "margin" : 0});
                    $(".layui-layer-tips .layui-layer-content").css({ "overflow": "hidden", "margin": "0", "padding": "0", "background": "rgba(150, 150, 150, 0.9)" });
                },
                error: function (data) {
                    layer.alert(data.responseText, { title: "快点云Pos提示" });
                }
            });
            $(obj).attr("data-keyboardShow",0);
        }
        else{
            layer.closeAll("tips");
            $(obj).attr("data-keyboardShow",1);
        }
    }

    function inputIGuest()
    {
        $(".otbIGuest input").val($(".otbIGuest input").last().val());
    }

    function closeTips()
    {
        layer.closeAll("tips");
    }

    //获取餐台状态统计数据
    function getStatistics(model) {
        $.ajax({
            url: '@Url.Action("GetTabStatusStatistics", "PosTabStatus")',
            type: "post",
            data: model,
            dataType: "json",
            success: function (data) {
                if (Boolean(data.Success)) {
                    $("#All").text(data.Data.All);
                    $("#Reserve").text(data.Data.Reserve);
                    $("#Empty").text(data.Data.Empty);
                    $("#Repair").text(data.Data.Repair);
                    $("#Sit").text(data.Data.Sit);
                    $("#Clean").text(data.Data.Clean);
                    $("#BeAlone").text(data.Data.BeAlone);
                    $("#Intimidate").text(data.Data.Intimidate);
                    $("#Operation").text(data.Data.Operation);
                    $("#TotalNumber").text(data.Data.TotalNumber);
                    $("#OriginalNumber").text(data.Data.OriginalNumber);
                    $("#PayBill").text(data.Data.PayBill);
                }
                else {
                    layer.alert(data.Data, { title: "快点云Pos提示" });
                }
            },
            error: function (data) {
                layer.alert(data.responseText, { title: "快点云Pos提示" });
            }
        });
    }

    //设置餐台样式
    function setTabBackClass() {
        var list = $(".mainRight-list").find("li");
        list.each(function () {
            var status = $(this).attr("data-staus");

            if (status == '@((byte)PosTabStatusEnum.已买单未离座)') {
                $(this).attr("class", "staus-clean");
            }
            else if (status == '@((byte)PosTabStatusEnum.已打单超时未买单)') {
                $(this).attr("class", "staus-intimidate");
            }
            else if (status == '@((byte)PosTabStatusEnum.落单后超时未有再点菜)') {
                $(this).attr("class", "staus-beAlone");
            }
            else if (status == '@((byte)PosTabStatusEnum.就座)') {
                $(this).attr("class", "staus-sit");
            }
            else if (status == '@((byte)PosTabStatusEnum.预订)') {
                $(this).attr("class", "staus-reserve");
            }
            else if (status == '@((byte)PosTabStatusEnum.维修)') {
                $(this).attr("class", "staus-repair");
            }
            else if (status == '@((byte)PosTabStatusEnum.空净)') {
                $(this).attr("class", "staus-empty");
            }
        });
    }

    function splitInterval()
    {
        var remValue = $("#remValue").height();
        var listHeight = Math.floor($(".mainRight-list ul").height());
        var listWidth = Math.floor($(".mainRight-list ul").width());
        var liHeight = $(".mainRight-list ul li").first().outerHeight(true);
        var liWidth = $(".mainRight-list ul li").first().outerWidth(true);

        //平均分配餐台间隔
        var right = Math.floor((listWidth % liWidth) / (listWidth / liWidth));
        var bottom = Math.floor((listHeight % liHeight) / (listHeight / liHeight));

        if(right > 0 && bottom > 0)
        {
            $(".mainRight-list li").css({ "margin-right": right + 0.5*remValue + "px", "margin-bottom": bottom + 0.5*remValue + "px" });
        }
        else if(right > 0 && bottom <= 0)
        {
            $(".mainRight-list li").css({ "margin-right": right + 0.5*remValue + "px" });
        }
        else if(right <= 0 && bottom > 0)
        {
            $(".mainRight-list li").css({ "margin-bottom": bottom + 0.5*remValue + "px" });
        }
    }

    //按台号/台名查询
    function keywordQuery(window, value) {
        $("#txtTabCode").val(value);

        var model = {
            Code: $("#txtTabCode").val(),
            Refeid: $("#refeid").val(),
            Tabtype: $("#tabtype").val(),
            TabStatus: $("#tabStatus").val(),
            PageSize: $("#pageSize").val(),
            PageIndex: 1,
            Mode: localStorage.getItem("posMode")
        };
        queryTabStatus(model);
        layer.closeAll();
    }

    //按营业厅查询
    function refeQuery(id, name) {
        $("#refeid").val(id);
        $("#btnRefe").val(name);
        localStorage.setItem("refeid", id);
        localStorage.setItem("refename", name);
        var model = {
            Code: $("#txtTabCode").val(),
            Refeid: $("#refeid").val(),
            Tabtype: $("#tabtype").val(),
            TabStatus: $("#tabStatus").val(),
            PageSize: $("#pageSize").val(),
            PageIndex: 1,
            Mode: localStorage.getItem("posMode")
        };
        queryTabStatus(model);
        layer.closeAll();
    }

    //按餐台类型查询
    function tabtypeQuery(id, name) {
        $("#tabtype").val(id);
        $("#btnTabtype").val(name);

        var model = {
            Code: $("#txtTabCode").val(),
            Refeid: $("#refeid").val(),
            Tabtype: $("#tabtype").val(),
            TabStatus: $("#tabStatus").val(),
            PageSize: $("#pageSize").val(),
            PageIndex: 1,
            Mode: localStorage.getItem("posMode")
        };
        queryTabStatus(model);
        layer.closeAll();
    }

    //按餐台状态查询
    function tabStatusQuery(code) {
        $("#tabStatus").val(code);
        var model = {
            Code: $("#txtTabCode").val(),
            Refeid: $("#refeid").val(),
            Tabtype: $("#tabtype").val(),
            TabStatus: $("#tabStatus").val(),
            PageSize: $("#pageSize").val(),
            PageIndex: 1,
            Mode: localStorage.getItem("posMode")
        };
        queryTabStatus(model);
    }

    //全部
    function queryAll() {
        $("#txtTabCode").val("");
        $("#refeid").val("");
        $("#tabtype").val("");
        $("#tabStatus").val("");

        var model = {
            Code: $("#txtTabCode").val(),
            Refeid: $("#refeid").val(),
            Tabtype: $("#tabtype").val(),
            TabStatus: $("#tabStatus").val(),
            PageSize: $("#pageSize").val(),
            PageIndex: 1,
            Mode: localStorage.getItem("posMode")
        };
        queryTabStatus(model);
    }

    //刷新
    function refresh() {
        var model = {
            Code: $("#txtTabCode").val(),
            Refeid: $("#refeid").val(),
            Tabtype: $("#tabtype").val(),
            TabStatus: $("#tabStatus").val(),
            PageSize: $("#pageSize").val(),
            PageIndex: 1,
            Mode: localStorage.getItem("posMode")
        };
        queryTabStatus(model);
    }
    //开台
    function openTab(tabid, tabno, billid, status,returnType) {
        var computerName = "";
        if ("undefined" != typeof jsObject) {
            computerName = jsObject.ComputerName;
        }
        var model = {
            Tabid: tabid,
            TabNo: tabno,
            ReturnType: returnType,
            Refeid: $("#refeid").val(),
            BillBsnsDate: $("#lblData").text(),
            ComputerName: computerName
        };
        if (status == 7 ) {
          

            //验证是否有开台属性
            $.ajax({
                url: '@Url.Action("CheckRefeOpenInfo", "PosTabStatus")',
                type: "post",
                data: model,
                dataType: "json",
                success: function (checkData) {
                    if (checkData.Success) {
                        if (checkData.Data=="0") {
                            //弹出开台界面
                            $.ajax({
                                url: '@Url.Action("_AddOpenTab", "PosTabStatus")',
                                type: "post",
                                data: model,
                                dataType: "html",
                                success: function (data) {
                                    layer.close(layer.index);
                                    layer.open({
                                        type: 1,
                                        title: "开台登记",
                                        skin: 'layui-layer-demo', //样式类名
                                        closeBtn: 0, //不显示关闭按钮
                                        shadeClose: true, //开启遮罩关闭
                                        area: ['auto', 'auto'], //宽高
                                        content: data
                                    });
                                },
                                error: function (data) {
                                    layer.alert(data.responseText, { title: "快点云Pos提示" });
                                }
                            });
                        }
                        else{
                            window.location.href=checkData.Data;
                        }

                    }

                },
                error: function (data) {
                    layer.alert(data.responseText, { title: "快点云Pos提示" });
                }
            });
        }
        else {

            $.ajax({
                url: '@Url.Action("AddTabLog", "PosTabStatus")',
                type: "post",
                data: model,
                dataType: "json",
                success: function (data) {
                    if (billid === "")
                    {
                        location.href = '@Url.Action("Index", "PosInSingle", new { rnd = new Random().NextDouble() })' + "&refeid=" + encodeURIComponent($("#refeid").val()) + "&tabid=" + encodeURIComponent(tabid) + "&billid=" + billid + "&tabFlag=0&openFlag=A";
                    }
                    else {
                        location.href = '@Url.Action("Index", "PosInSingle", new { rnd = new Random().NextDouble() })' + "&refeid=" + encodeURIComponent($("#refeid").val()) + "&tabid=" + encodeURIComponent(tabid) + "&billid=" + billid + "&tabFlag=1&openFlag=A";
                    }
                },
                error: function (data) {
                    layer.alert(data.responseText, { title: "快点云Pos提示" });
                }
            });
        }
    }
    //锁台
    function isLockTab(tabid, tabno, billid, status) {
        $("#tabid").val(tabid);
        $("#billid").val(billid);
        $("#tabNo").val(tabno);
        var model = {
            Tabid: tabid,
            TabNo: tabno,
            Billid: billid
        };

        $.ajax({
            url: '@Url.Action("GetSmearList", "PosTabStatus")',
            type: "post",
            data: { tabid:tabid },
            dataType: "json",
            success: function (smear) {
                if (smear.Success == true) {
                    if(smear.Data == "")
                    {
                        if(Boolean($("#isOpenBrush").val()) == true){
                            var computerName = "";
                            if("undefined" != typeof jsObject)
                            {
                                computerName = jsObject.ComputerName;
                            }
                            $.ajax({
                                url: '@Url.Action("AddLockTab", "PosTabStatus")',
                                type: "post",
                                data: model,
                                dataType: "json",
                                success: function (data) {
                                    //没有开台的餐台根据营业点设置的属性是否弹出刷卡界面
                                    if (data.Success==true) {
                                        var cardModel = {
                                            ReturnType: 1,
                                            Message: "请刷卡...",
                                            Callback: "$('#isAutoLogin').val('false');openTab('" + tabid + "', '" + tabno + "', '"+billid+"','"+ status+"','1');",
                                            Tabid: tabid,
                                            TabNo: tabno,
                                            Billid: billid,
                                            ComputerName:computerName
                                        };
                                        $.ajax({
                                            url: '@Url.Action("_PayByCard", "Shared")',
                                            type: "post",
                                            data: cardModel,
                                            dataType: "html",
                                            success: function (cardData) {
                                                layer.open({
                                                    type: 1,
                                                    title: "刷卡",
                                                    skin: 'layui-layer-demo', //样式类名
                                                    closeBtn: 0, //不显示关闭按钮
                                                    area: ['auto', 'auto'], //宽高
                                                    content: cardData
                                                });
                                            },
                                            error: function (cardData) {
                                                layer.alert(cardData.responseText, { title: "快点云Pos提示" });
                                            }
                                        });

                                    }
                                    else if (data.Success == false) {
                                        //有锁台记录的并且可以多人操作餐台的
                                        if (data.ErrorCode == 2) {
                                            layer.confirm(data.Data, {
                                                btn: ['继续', '取消'] //按钮
                                               ,title: '快点云Pos提示'
                                               ,shade: 'rgba(0,0,0,0)'
                                            }, function () {
                                                var cardModel = {
                                                    ReturnType: 1,
                                                    Message: "请刷卡...",
                                                    Callback: "$('#isAutoLogin').val('false');openTab('" + tabid + "', '" + tabno + "', '"+billid+"','"+ status+"','1');",
                                                    Tabid: tabid,
                                                    TabNo: tabno,
                                                    Billid: billid,
                                                    ComputerName:computerName
                                                };
                                                $.ajax({
                                                    url: '@Url.Action("_PayByCard", "Shared")',
                                                    type: "post",
                                                    data: cardModel,
                                                    dataType: "html",
                                                    success: function (cardData) {
                                                        layer.open({
                                                            type: 1,
                                                            title: "刷卡",
                                                            skin: 'layui-layer-demo', //样式类名
                                                            closeBtn: 0, //不显示关闭按钮
                                                            area: ['auto', 'auto'], //宽高
                                                            content: cardData
                                                        });
                                                    },
                                                    error: function (cardData) {
                                                        layer.alert(cardData.responseText, { title: "快点云Pos提示" });
                                                    }
                                                });
                                            }, function () {
                                                layer.closeAll();
                                            });
                                        }
                                        else  {
                                            layer.alert(data.Data, { title: "快点云Pos提示" });
                                        }
                                    }
                                },
                                error: function (data) {
                                    layer.alert(data.responseText, { title: "快点云Pos提示" });
                                }
                            });
                        }
                        else {
                            $.ajax({
                                url: '@Url.Action("AddLockTab", "PosTabStatus")',
                                type: "post",
                                data: model,
                                dataType: "json",
                                success: function (data) {
                                    if (data.Success==true) {
                                        openTab(tabid, tabno, billid, status,'2');
                                    }
                                    else if (data.Success == false) {
                                        //有锁台记录的并且可以多人操作餐台的
                                        if (data.ErrorCode == 2) {
                                            layer.confirm(data.Data, {
                                                btn: ['继续', '取消'] //按钮
                                               ,title: '快点云Pos提示'
                                               ,shade: 'rgba(0,0,0,0)'
                                            }, function () {
                                                openTab(tabid, tabno, billid, status,'2');
                                            }, function () {
                                                layer.closeAll();
                                            });
                                        }
                                        else  {
                                            layer.alert(data.Data, { title: "快点云Pos提示" });
                                        }
                                    }
                                },
                                error: function (data) {
                                    layer.alert(data.responseText, { title: "快点云Pos提示" });
                                }
                            });

                        }

                    }
                    else
                    {
                        $.ajax({
                            url: '@Url.Action("_PosSmearList", "PosTabStatus")',
                            type: "post",
                            data: { model : JSON.stringify(smear.Data) },
                            dataType: "html",
                            success: function (data) {
                                layer.open({
                                    type: 1,
                                    title: "抹台",
                                    skin: 'layui-layer-demo', //样式类名
                                    closeBtn: 1, //不显示关闭按钮
                                    shadeClose:true,
                                    area: ['auto', 'auto'], //宽高
                                    content: data
                                });
                            },
                            error: function (data) {
                                layer.alert(data.responseText, { title: "快点云Pos提示" });
                            }
                        });
                    }
                }
                else {
                    layer.alert(smear.Data, { title: "快点云Pos提示" });
                }
            },
            error: function (data) {
                layer.alert(data.responseText, { title: "快点云Pos提示" });
            }
        });
    }

    function openTabRedirect()
    {
        var refeid = $("#refeid").val();
        var tabid = $("#tabid").val();
        var billid = $("#billid").val();
        if (billid === "") {
            location.href = '@Url.Action("Index", "PosInSingle", new { rnd = new Random().NextDouble() })' + "&refeid=" + encodeURIComponent(refeid) + "&tabid=" + encodeURIComponent(tabid) + "&billid=" + billid + "&tabFlag=0&openFlag=A";
        }
        else {
            location.href = '@Url.Action("Index", "PosInSingle", new { rnd = new Random().NextDouble() })' + "&refeid=" + encodeURIComponent(refeid) + "&tabid=" + encodeURIComponent(tabid) + "&billid=" + billid + "&tabFlag=1&openFlag=A";
        }
    }

    //提交
    function saveFormData(btn, window) {
        var f = $(btn)[0].form;
        var validator = $(f).validate();
        if (validator.form()) {
            $.post(
                $(f).attr("action"),
                $(f).serialize(),
                function (data) {
                    if (data.Success) {
                        if (window === undefined) {
                            closeGeneralWindow();
                        }
                        else {
                            layer.closeAll();
                        }

                        if ($("#isAutoLogin").val() == "true") {
                            cardModel = {
                                ReturnType: 2,
                                Message: "请刷卡...",
                                Callback: "$('#isAutoLogin').val('false');openTabRedirect();",
                            };

                            $.ajax({
                                url: '@Url.Action("_PayByCard", "Shared")',
                                type: "post",
                                data: cardModel,
                                dataType: "html",
                                success: function (cardData) {
                                    layer.open({
                                        type: 1,
                                        title: "刷卡",
                                        skin: 'layui-layer-demo', //样式类名
                                        closeBtn: 0, //不显示关闭按钮
                                        area: ['auto', 'auto'], //宽高
                                        content: cardData
                                    });
                                },
                                error: function (data) {
                                    layer.alert(data.responseText, { title: "快点云Pos提示" });
                                }
                            });
                        }
                        else
                        {
                            if (data.Data!="") {
                                location.href=data.Data;

                            }
                            if ($("#billid").val() == "") {
                                location.href = '@Url.Action("Index", "PosInSingle", new { rnd = new Random().NextDouble() })' + "&refeid=" + encodeURIComponent($("#refeid").val()) + "&tabid=" + encodeURIComponent($("#tabid").val()) + "&billid=" + $("#billid").val() + "&tabFlag=0&openFlag=A";
                            }
                            else {
                                location.href = '@Url.Action("Index", "PosInSingle", new { rnd = new Random().NextDouble() })' + "&refeid=" + encodeURIComponent($("#refeid").val()) + "&tabid=" + encodeURIComponent($("#tabid").val()) + "&billid=" + $("#billid").val() + "&tabFlag=1&openFlag=A";
                            }
                        }

                    } else {
                        if (data.ErrorCode == 2) {
                            layer.confirm(data.Data, {
                                btn: ['继续', '取消'] //按钮
                                ,title: '快点云Pos提示'
                                ,shade: 'rgba(0,0,0,0)'
                            }, function () {
                                cardModel = {
                                    ReturnType: 2,
                                    Message: "请刷卡...",
                                    Callback: "$('#isAutoLogin').val('false');openTabRedirect();",
                                    Tabid: $("#tabid").val(),
                                    TabNo: $("#tabNo").val(),
                                    Billid:  $("#billid").val(),
                                };
                                $.ajax({
                                    url: '@Url.Action("_PayByCard", "Shared")',
                                    type: "post",
                                    data: cardModel,
                                    dataType: "html",
                                    success: function (cardData) {
                                        layer.open({
                                            type: 1,
                                            title: "刷卡",
                                            skin: 'layui-layer-demo', //样式类名
                                            closeBtn: 0, //不显示关闭按钮
                                            area: ['auto', 'auto'], //宽高
                                            content: cardData
                                        });
                                    },
                                    error: function (data) {
                                        layer.alert(data.responseText, { title: "快点云Pos提示" });
                                    }
                                });
                            }, function () {
                                layer.closeAll();
                            });
                        }
                        else {
                            layer.alert(data.Data, { title: "快点云Pos提示" });
                        }

                    }
                },
            "json");
        }
    }

    //隐藏/展开左侧列表
    function OpenShrink(obj) {
        var width = $(".mainRight").width();
        var remValue = $("#remValue").width();
        if ($(obj).text() == "隐藏") {
            $(obj).text("展开");
            $(".mainRight").width($(window).width());
            $(".mainLeft").hide();
        }
        else {
            $(obj).text("隐藏");
            $(".mainRight").width($(window).width() - $(".mainLeft").outerWidth(true));
            $(".mainLeft").show();
        }
        InTabStatusList();
    }

    //全屏/正常
    function fullScreen(obj) {
        if ($(obj).text() == "全屏") {
            $(obj).text("正常");
            requestFullScreen();
        }
        else {
            $(obj).text("全屏");
            exitFullscreen();
        }
    }

    //输入台号
    function inputTabNo() {
        var model = {
            Title: "台号：",
            Message: "请输入台号/台名",
            Value: $("#txtTabCode").val(),
            Callback: "searchTabStatus();",
            InputCallback:"searchTabStatus();",
        };

        $.ajax({
            url: '@Url.Action("_LetterInput", "PosInSingle")',
            type: "post",
            data: model,
            dataType: "html",
            success: function (data) {
                $("#inputWindow").html(data);
                $("#inputWindow").data("kendoWindow").center().open();
            },
            error: function (data) {
                layer.alert(data.responseText, { title: "快点云Pos提示" });
            }
        });
    }

    //查询餐台状态
    function searchTabStatus() {
        $("#txtTabCode").val($("#txtInputValue").val());

        var model = {
            Code: $("#txtTabCode").val(),
            Refeid: $("#refeid").val(),
            Tabtype: $("#tabtype").val(),
            TabStatus: $("#tabStatus").val(),
            PageSize: $("#pageSize").val(),
            PageIndex: 1,
            Mode: localStorage.getItem("posMode")
        };
        queryTabStatus(model);
    }

    //显示提示
    function tipShow(obj) {
        layer.tips($(obj).attr("data-msg"), $(obj), {
            tips: [$(obj).attr("data-position"),"#111"], //还可配置颜色
            time: $("#tipsTime").val(),
        });
    }

    //隐藏提示
    function tipHide(obj) {
        layer.closeAll('tips');
    }

    //提示消息
    function tipMsg(obj) {
        layer.msg($(obj).attr("data-msg"), {
            time: $("#tipsTime").val(),
        });
    }

    function exitTabStatus()
    {
        if ("undefined" != typeof jsObject) {   //封装程序登录
            cardModel = {
                ReturnType: 2,
                Message: "请刷卡退出程序……",
                Callback: "ExitProcedure()",
                Flag:"C"
            };

            $.ajax({
                url: '@Url.Action("_PayByCard", "Shared")',
                type: "post",
                data: cardModel,
                dataType: "html",
                success: function (cardData) {
                    layer.open({
                        type: 1,
                        title: "刷卡",
                        skin: 'layui-layer-demo', //样式类名
                        closeBtn: 0, //不显示关闭按钮
                        area: ['auto', 'auto'], //宽高
                        content: cardData
                    });
                },
                error: function (data) {
                    layer.alert(data.responseText, { title: "快点云Pos提示" });
                }
            });
        }
        else
        {
            localStorage.removeItem("refeid");
            localStorage.removeItem("refename")
            if ($("#isAutoLogin").val() == "true") {
                location.href = '@Url.Action("Index", "../Account")';
            }else{
                location.href = '@Url.Action("Index", "../Home")';
            }
        }
    }

    //退出程序
    function ExitProcedure() {
        if ("undefined" != typeof jsObject) //如果是封装程序
        {
            jsObject.Exit();
        }
    }

    // 对Date的扩展，将 Date 转化为指定格式的String
    // 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，
    // 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)
    Date.prototype.FormatTime = function (fmt) { //author: meizz
        var o = {
            "M+": this.getMonth() + 1, //月份
            "d+": this.getDate(), //日
            "H+": this.getHours(), //小时
            "m+": this.getMinutes(), //分
            "s+": this.getSeconds(), //秒
            "q+": Math.floor((this.getMonth() + 3) / 3), //季度
            "S": this.getMilliseconds() //毫秒
        };
        if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (var k in o)
            if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        return fmt;
    }

    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return r[2]; return '';
    }

    //沽清
    function sellOut()
    {
        $.ajax({
            url: '@Url.Action("_SellOut", "PosTabStatus")',
            type: "post",
            data: {refeId:$("#refeid").val()},
            dataType: "html",
            success: function (cardData) {
                var jsonCardData=isJson(cardData);
                if (jsonCardData==false) {
                    //不是json 格式
                    layer.open({
                        type: 1,
                        title: false,
                        skin: 'layui-layer-demo', //样式类名
                        closeBtn: 0, //不显示关闭按钮
                        area: ['800px', '500px'], //宽高
                        content: cardData,
                        shadeClose: true, //开启遮罩关闭
                    });
                }
                else {
                    var obj= JSON.parse(cardData);
                    if (obj.Success==false) {
                        layer.alert(obj.Data, { title: "快点云Pos提示" });
                        return false;
                    }
                }
            },
            error: function (dacardDatata) {
                layer.alert(data.responseText, { title: "快点云Pos提示" });
            }
        });
    }

    //验证字符串是否是json格式
    function isJson(str){
        if (typeof str == 'string') {
            try {
                var obj=JSON.parse(str);
                if(typeof obj == 'object' && obj ){
                    return true;
                }else{
                    return false;
                }

            } catch(e) {
                return false;
            }
        }
        return true;
    }

    //复位
    function Restoration()
    {
        $.ajax({
            url: '@Url.Action("_Restoration", "PosTabStatus")',
            type: "post",
            data: {refeId:$("#refeid").val()},
            dataType: "html",
            success: function (cardData) {
                var jsonCardData=isJson(cardData);
                if (jsonCardData==false) {
                    //不是json 格式
                    layer.open({
                        type: 1,
                        title: false,
                        skin: 'layui-layer-demo', //样式类名
                        closeBtn: 0, //不显示关闭按钮
                        area: ['800px', '500px'], //宽高
                        content: cardData,
                        shadeClose: true, //开启遮罩关闭
                        id:"RestorationList"
                    });
                }
                else {
                    var obj= JSON.parse(cardData);
                    if (obj.Success==false) {
                        layer.alert(obj.Data, { title: "快点云Pos提示" });
                        return false;
                    }
                }
            },
            error: function (dacardDatata) {
                layer.alert(data.responseText, { title: "快点云Pos提示" });
            }
        });
    }
    //复位全选
    function checkedRowAll(obj) {
        var ids = "";
        $("#selIds").val("");
        var grid = $("#gridSelect").data("kendoGrid");

        if ($(obj).is(":checked")) {
            grid.tbody.find(">tr:not(.k-grouping-row) input[type='checkbox']").prop("checked", true);

            var dataRows = grid.items();
            for (var i = 0; i < dataRows.length; i++) {
                var row = grid.tbody.find(">tr:not(.k-grouping-row)").eq(i);
                var data = grid.dataItem(dataRows[i]);
                ids += "|" + data["Id"];
            }
            $("#selIds").val(ids);
        }
        else {
            grid.tbody.find(">tr:not(.k-grouping-row) input[type='checkbox']").prop("checked", false);
        }
    }

    //单选
    function checkedRow(obj) {
        var ids = $("#selIds").val();
        var grid = $("#gridSelect").data("kendoGrid");

        if ($(obj).is(":checked")) {
            $("#selIds").val(ids + "|" + $(obj).val());

            var dataRows = grid.items();
            for (var i = 0; i < dataRows.length; i++) {
                var row = grid.tbody.find(">tr:not(.k-grouping-row)").eq(i);
                var data = grid.dataItem(dataRows[i]);
            }
        }
        else {
            //  ids = "";
            var arr = $.grep(ids.split('|'), function (value) {
                return value !== $(obj).val();
            });
            dataRows = grid.items();
            ids="";
            for (i = 0; i < dataRows.length; i++) {

                row = grid.tbody.find(">tr:not(.k-grouping-row)").eq(i);
                data = grid.dataItem(dataRows[i]);
                for (var j = 0; j < arr.length; j++) {
                    if (data["Id"] === arr[j]) {
                        ids += "|" + data["Id"];
                    }
                }
            }
            $("#selIds").val(ids);
        }
    }
    //保存复位信息
    function UpdateRestoration()
    {
        var ids=$("#selIds").val();
        if (ids=="") {
            layer.alert("请选择要复位的餐台", { title: "快点云Pos提示" });
            return false;
        }
        $.ajax({
            url: '@(Url.Action("UpdateRestoration", "PosTabStatus", new { rnd = new Random().NextDouble() }))' + "&ids=" + ids,
            type: "post",
            dataType: "json",
            success: function (data) {
                $("#gridSelect").data("kendoGrid").dataSource.read();
            },
            error: function (data) {
                layer.alert(data.responseText, { title: "快点云Pos提示" });
            }
        });
    }
    function closeRestoration()
    {
        $("#selIds").val("");
        layer.closeAll();
    }

    function refreshFaultPrinter() {
        $.ajax({
            url: '@Url.Action("GetFaultPrinter", "PosTabStatus")',
            type: "post",
            data: {},
            dataType: "json",
            success: function (data) {
                if (Boolean(data.Success)) {
                    $(".mesage").html("<li></li>");
                    $(".mesage li").html(data.Data);
                    $('.mesage').liMarquee({ scrollamount: 30 });
                }
                else {
                    console.log(data.Data);
                }
            },
            error: function (data) {
                console.log(data.responseText);
            }
        });
    }
</script>
<script src="~/Scripts/layer-v3.1.1/layer.js"></script>